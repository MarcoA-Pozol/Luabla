{% load static %}

<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static "css/_deck_lists.css" %}">

{% if decks %}
    {% for deck in decks %}
        <div class="deck" id="deck-{{ deck.pk }}">
            <h3>{{ deck.title }}</h3>
            {% if deck.image %}
                <img src="{{ deck.image.url }}" alt="{{ deck.title }}">
            {% else %}
                <img src="{% static 'images/default_deck_image.jpg' %}" alt="Default image">
            {% endif %}
            <p>{{ deck.description }}</p>
            <h4>
                <b id="author">{{ deck.author }}</b>  
                <b id="downloads">⏏ {{ deck.downloads }}</b>  
                {% if language == "Chinese" %}
                    <b id="hsk_level">{{ deck.hsk_level }}</b> 
                {% else %}
                    <b id="cefr_level">{{ deck.cefr_level }}</b> 
                {% endif %}
                <b id="starts_rating">☆ 5</b>  
                <b id="cards_cuantity">❐ {{ deck.cards_cuantity }}</b>
            </h4>
            <button class="get-deck-button" data-id="{{ deck.pk }}" type="submit">Add</button>
        </div>
    {% endfor %}
{% else %}
    <h5 id="no_decks_available" style="
    width: 100%;
    text-align: center;
    justify-content: center;
    align-content: center;
    font-size: 2.0rem;
    color: #111111;">No more decks available</h5>
{% endif %}
        
<div id="alert-box" class="hidden">
    Deck obtained successfully!
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
    // Debugging: Log the raw cards JSON to the console for verification
    console.log("Deck JSON:", JSON.parse('{{ decks_json|escapejs }}')); 

    // Parse Decks to JSON safely
    let decks_list = JSON.parse('{{ decks_json|escapejs}}');

    function showAlert() {
        const alertBox = document.getElementById('alert-box');
        alertBox.classList.remove('hidden');
        alertBox.classList.add('visible');
    
        // Remove the alert after 2.5 seconds
        setTimeout(() => {
            alertBox.classList.remove('visible');
            alertBox.classList.add('hidden');
        }, 2500);
    }

    $(document).ready(function() {
        // Listen for click events on buttons with the "get-deck-button" class
        $('.get-deck-button').on('click', function() {
            const deckId = $(this).data('id'); // Retrieve deck ID from data-id
            if (!deckId) {
                console.error("No deck ID found for this button.");
                return;
            }
    
            // Make AJAX request to save the current user as an owner of the deck
            $.ajax({
                url: "{% url 'get-deck-ajax' %}", // Django URL for adding a deck
                type: "POST",
                data: JSON.stringify({ deck_id: deckId }), // Send deck_id to the backend
                contentType: "application/json",
                headers: { "X-CSRFToken": "{{ csrf_token }}" }, // Include CSRF token for security
                success: function(response) {
                    console.log("Deck obtained:", response.message);
                    // alert(response.message); // Optional user feedback

                    // Remove the deck's HTML element from the DOM
                    $(`#deck-${deckId}`).remove();

                    // Notify the user that a new deck is obtained to study.
                    showAlert()

                    // If no more decks available
                    if ($('.deck').length === 0) {
                        showAlert()
                        $('#decks-container').html(`
                            <h5 id="no_decks_available" style="
                                width: 100%;
                                text-align: center;
                                justify-content: center;
                                align-content: center;
                                font-size: 2.0rem;
                                color: #222;">
                                No more decks available
                            </h5>
                            <h6 style="margin-left:30%;width:40%;text-align: center;justify-content: center;font-size: 1.4rem;color: #333;">Redirecting...</h6>
                        `);

                        // Redirect to learn page after the user had obtained all the decks and there are not more available.
                        setTimeout(() => {
                            window.location.href = "{% url 'study' %}"
                        }, 1800);
                    }
                },
                error: function(error) {
                    console.error("Error obtaining deck:", error.responseJSON?.error || error);
                },
            });
        });
    });    
</script>